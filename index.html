<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ЗП — расчёт продаж (локально)</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --accent:#0b66ff; --muted:#6b7280;
    --danger:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#111;background:var(--bg);}
  .app{max-width:1100px;margin:12px auto;padding:12px;min-height:calc(100vh - 24px);}
  header{position:sticky;top:0;z-index:50;background:transparent;padding:6px 0;}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;background:transparent}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#3ea0ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px}
  .title{font-size:18px;font-weight:600}
  .header-right{display:flex;gap:8px;align-items:center}
  .chip{background:var(--card);padding:8px 10px;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.04);display:flex;gap:8px;align-items:center}
  .static-header{position:sticky;top:66px;background:var(--card);padding:10px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.05);display:flex;align-items:center;justify-content:space-between;z-index:40}
  .static-left{display:flex;gap:12px;align-items:center}
  .username{font-weight:700}
  .office-select{min-width:220px}
  input[type="text"], select, input[type="number"]{
    padding:8px;border:1px solid #e6e9ef;border-radius:6px;font-size:14px;background:white;
  }
  button{cursor:pointer;border:0;padding:8px 10px;border-radius:8px;background:var(--accent);color:white;font-weight:600}
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,102,255,0.12)}
  .controls{display:flex;gap:8px;align-items:center}
  main{margin-top:12px}
  /* calendar */
  .calendar-card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.04)}
  .cal-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .weekday{font-size:12px;color:var(--muted);text-align:center;padding:6px 0}
  .day{
    background:linear-gradient(180deg,#fff, #fbfdff);
    min-height:88px;padding:8px;border-radius:8px;border:1px solid #eef2f7;display:flex;flex-direction:column;justify-content:flex-start;
    overflow:hidden;
  }
  .day.small{min-height:66px}
  .day .date{font-size:13px;font-weight:700}
  .day .dot{width:8px;height:8px;border-radius:50%}
  .today{box-shadow:0 0 0 2px rgba(11,102,255,0.09) inset}
  .has-data{outline:3px solid rgba(16,185,129,0.08)}
  .muted{color:var(--muted);font-size:13px}
  .day-actions{margin-top:auto;display:flex;gap:6px;align-items:center}
  .small-note{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* modal */
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:60}
  .overlay.show{display:flex}
  .modal{
    background:var(--card);border-radius:10px;padding:12px;max-width:920px;width:100%;
    max-height:90vh;overflow:auto;box-shadow:0 16px 40px rgba(2,6,23,0.3);position:relative;
  }
  .modal .row{display:flex;gap:8px;align-items:center}
  .tabs{display:flex;gap:6px;margin:8px 0;flex-wrap:wrap}
  .tab{padding:8px 10px;border-radius:8px;background:#f3f6fb;border:1px solid #e8eefc;cursor:pointer;font-weight:600}
  .tab.active{background:linear-gradient(90deg,#eef7ff,#fff);border-color:rgba(11,102,255,0.18)}
  .sublist{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;margin-top:8px}
  .subitem{background:#fbfdff;border:1px solid #eef6ff;padding:8px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .subitem label{font-weight:600}
  .footer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .meta{font-size:13px;color:var(--muted)}
  /* responsive */
  @media (max-width:700px){
    .static-header{flex-direction:column;align-items:flex-start;gap:8px}
    .brand{gap:8px}
    .day{min-height:72px}
  }
  /* avoid horizontal overflow */
  html,body,.app{overflow-x:hidden}
  /* small helper */
  .export-area{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Приложение расчёта ЗП">
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="logo">ЗП</div>
          <div>
            <div class="title">Прототип — расчёт продаж</div>
            <div class="small">Все данные хранятся локально на устройстве</div>
          </div>
        </div>
        <div class="header-right">
          <div class="chip small" title="Экспорт / импорт данных">
            <div class="export-area">
              <button id="exportBtn" title="Экспорт данных">Экспорт</button>
              <button id="importBtn" class="ghost" title="Импорт данных">Импорт</button>
              <input id="importFile" type="file" accept="application/json" style="display:none">
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="static-header" aria-hidden="false">
      <div class="static-left">
        <div>
          <div class="username" id="displayName">—</div>
          <div class="meta">Имя (шапка приложения)</div>
        </div>
        <div style="width:12px"></div>
        <div>
          <select id="officeSelect" class="office-select"></select>
          <div class="small">Офис (сохранится локально и можно экспортировать)</div>
        </div>
      </div>
      <div class="controls">
        <button id="editNameBtn" class="ghost">Изменить имя</button>
        <button id="addOfficeBtn" class="ghost">Добавить офис</button>
        <button id="saveOfficeFile" title="Сохранить выбранный офис в файл">Сохранить офис в файл</button>
      </div>
    </div>

    <main>
      <section class="calendar-card" aria-label="Календарь">
        <div class="cal-head">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="prevMonth" class="ghost">&larr;</button>
            <button id="nextMonth" class="ghost">&rarr;</button>
            <div id="monthLabel" class="meta"></div>
          </div>
          <div class="meta">Нажми на дату — появится окно ввода продаж</div>
        </div>

        <div class="cal-grid" id="weekdays" aria-hidden="true"></div>
        <div class="cal-grid" id="calendar"></div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="modalTitle" style="font-weight:800"></div>
          <div class="meta" id="modalMeta"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="dataTag" class="small muted"></div>
          <button id="closeModal" class="ghost">Закрыть</button>
        </div>
      </div>

      <div class="tabs" id="categoryTabs" role="tablist" aria-label="Категории продаж"></div>

      <div id="sublist" class="sublist" aria-live="polite"></div>

      <div class="footer-actions">
        <button id="clearDay" class="ghost" title="Удалить все продажи за день">Очистить день</button>
        <button id="saveDay">Сохранить</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // --- Data model and defaults ---
  const DEFAULT_OFFICES = [
    "Центральный","Коммерческий деп. 1","Коммерческий деп. 2","ДО \"Северный\"","ДО \"Южный\""
  ];

  const CATEGORIES = {
    "КК": ["Рассм.","заявка","сплит"],
    "ПК": ["Заявка","выдача"],
    "ТА": ["Яркая","Другие","ЕКП","МА"],
    "Накопит": ["Вклад","НС.","МА выдача","СМС","Лид ЦПО","Лид Ипотека"],
    "ПЕНС": ["Военный","Страховая"],
    "Страховки": [] // эта категория оставлена пустой (если понадобятся подвиды — добавим)
  };

  // localStorage keys
  const KEY_USER = "zp_user";
  const KEY_OFFICES = "zp_offices";
  const KEY_SALES = "zp_sales";

  // --- helpers ---
  function q(id){return document.getElementById(id)}
  function isoDate(d){ const y=d.getFullYear(), m=(d.getMonth()+1).toString().padStart(2,'0'), day=(d.getDate()).toString().padStart(2,'0'); return `${y}-${m}-${day}` }

  // --- load/save ---
  function loadJSON(key, fallback){ try{ const v=localStorage.getItem(key); return v? JSON.parse(v): fallback }catch(e){return fallback} }
  function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)) }

  // init data
  let user = loadJSON(KEY_USER, {name:"", office:""});
  let offices = loadJSON(KEY_OFFICES, DEFAULT_OFFICES);
  let sales = loadJSON(KEY_SALES, {}); // { "2025-12-04": { office:..., name:..., entries: {category: {sub: qty}} } }

  // --- UI refs ---
  const displayName = q('displayName');
  const officeSelect = q('officeSelect');
  const editNameBtn = q('editNameBtn');
  const addOfficeBtn = q('addOfficeBtn');
  const saveOfficeFile = q('saveOfficeFile');
  const exportBtn = q('exportBtn');
  const importBtn = q('importBtn');
  const importFile = q('importFile');

  // initialize header
  function renderHeader(){
    displayName.textContent = user.name || "Не задано ФИО (нажмите «Изменить имя»)";
    renderOfficeList();
  }

  function renderOfficeList(){
    officeSelect.innerHTML = "";
    const placeholder = document.createElement('option');
    placeholder.value = "";
    placeholder.textContent = "Выберите офис";
    officeSelect.appendChild(placeholder);

    offices.forEach(o=>{
      const opt = document.createElement('option');
      opt.value = o;
      opt.textContent = o;
      officeSelect.appendChild(opt);
    });
    officeSelect.value = user.office || "";
  }

  officeSelect.addEventListener('change', ()=>{
    user.office = officeSelect.value;
    saveJSON(KEY_USER, user);
    renderHeader();
  });

  editNameBtn.addEventListener('click', ()=>{
    const val = prompt("Введите Фамилию и имя (отобразится в шапке):", user.name || "");
    if(val===null) return;
    user.name = val.trim();
    saveJSON(KEY_USER, user);
    renderHeader();
  });

  addOfficeBtn.addEventListener('click', ()=>{
    const val = prompt("Добавить название офиса:", "");
    if(!val) return;
    offices = [...new Set([val.trim(), ...offices])];
    saveJSON(KEY_OFFICES, offices);
    renderOfficeList();
    officeSelect.value = val.trim();
    user.office = val.trim();
    saveJSON(KEY_USER, user);
    renderHeader();
  });

  saveOfficeFile.addEventListener('click', ()=>{
    if(!user.office){ alert("Выберите офис перед сохранением в файл."); return; }
    const blob = new Blob([JSON.stringify({office:user.office},null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `office-${(user.office||'office').replace(/\s+/g,'_')}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // export/import full dataset
  exportBtn.addEventListener('click', ()=>{
    const pack = { user, offices, sales, exportedAt: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(pack,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = `zp-data-${(new Date()).toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove();
  });

  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', async (ev)=>{
    const f = ev.target.files[0]; if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(obj.user) user = obj.user;
      if(obj.offices) offices = obj.offices;
      if(obj.sales) sales = obj.sales;
      saveJSON(KEY_USER, user);
      saveJSON(KEY_OFFICES, offices);
      saveJSON(KEY_SALES, sales);
      renderHeader(); renderCalendar();
      alert("Импорт выполнен.");
    }catch(e){ alert("Ошибка импорта: "+e.message) }
    importFile.value = "";
  });

  // --- Calendar UI ---
  const weekdays = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];
  const monthNames = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];

  const weekHead = q('weekdays');
  weekdays.forEach(w=>{
    const el = document.createElement('div');
    el.className='weekday'; el.textContent = w; weekHead.appendChild(el);
  });

  let viewDate = new Date(); // current month view

  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

  const monthLabel = q('monthLabel');
  const calendarEl = q('calendar');

  q('prevMonth').addEventListener('click', ()=> { viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1); renderCalendar(); });
  q('nextMonth').addEventListener('click', ()=> { viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1); renderCalendar(); });

  function renderCalendar(){
    calendarEl.innerHTML = "";
    monthLabel.textContent = `${monthNames[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
    const first = startOfMonth(viewDate);
    // get day of week index (Mon=0..Sun=6)
    const firstWeekday = (first.getDay() + 6) % 7;
    const daysInMonth = endOfMonth(viewDate).getDate();

    // fill blanks
    for(let i=0;i<firstWeekday;i++){
      const blank = document.createElement('div'); blank.className='day small'; blank.style.visibility='hidden';
      calendarEl.appendChild(blank);
    }

    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
      const iso = isoDate(date);
      const cell = document.createElement('div');
      cell.className='day';
      if(window.innerWidth < 700) cell.classList.add('small');
      if(iso === isoDate(new Date())) cell.classList.add('today');
      if(sales[iso]) cell.classList.add('has-data');

      const top = document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.alignItems='center';
      const dateEl = document.createElement('div'); dateEl.className='date'; dateEl.textContent = d;
      const dot = document.createElement('div'); dot.className='dot';
      dot.style.background = sales[iso] ? 'linear-gradient(180deg,#10b981,#059669)' : '#e6edf7';
      top.appendChild(dateEl); top.appendChild(dot);

      const content = document.createElement('div'); content.style.marginTop='6px';
      if(sales[iso]){
        const entries = sales[iso].entries || {};
        const total = Object.values(entries).reduce((acc,cat)=> {
          if(typeof cat === 'object'){
            acc += Object.values(cat).reduce((a,v)=> a + (Number(v)||0), 0);
          }
          return acc;
        },0);
        const txt = document.createElement('div'); txt.className='small-note'; txt.textContent = `Продаж: ${total}`;
        content.appendChild(txt);
      } else {
        const txt = document.createElement('div'); txt.className='muted'; txt.textContent = 'Пусто';
        content.appendChild(txt);
      }

      const actions = document.createElement('div'); actions.className='day-actions';
      const openBtn = document.createElement('button'); openBtn.textContent='Открыть'; openBtn.className='ghost';
      openBtn.addEventListener('click', ()=> openModalForDate(iso));
      actions.appendChild(openBtn);

      cell.appendChild(top); cell.appendChild(content); cell.appendChild(actions);
      calendarEl.appendChild(cell);
    }
  }

  // --- Modal logic ---
  const overlay = q('overlay');
  const modalTitle = q('modalTitle');
  const modalMeta = q('modalMeta');
  const categoryTabs = q('categoryTabs');
  const sublist = q('sublist');
  const dataTag = q('dataTag');
  const closeModal = q('closeModal');
  const saveDay = q('saveDay');
  const clearDay = q('clearDay');

  let currentIso = null;
  let currentWorking = null; // temp workspace

  function openModalForDate(iso){
    currentIso = iso;
    modalTitle.textContent = iso;
    modalMeta.textContent = `${monthNames[ new Date(iso).getMonth() ]} ${new Date(iso).getFullYear()}`;
    dataTag.textContent = user.office ? `Офис: ${user.office}` : "Офис не выбран";
    overlay.classList.add('show');

    // populate tabs
    categoryTabs.innerHTML = "";
    Object.keys(CATEGORIES).forEach((cat, idx)=>{
      const t = document.createElement('button');
      t.className='tab'+(idx===0?' active':'');
      t.setAttribute('role','tab'); t.textContent = cat;
      t.addEventListener('click', ()=> {
        categoryTabs.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        renderSublist(cat);
      });
      categoryTabs.appendChild(t);
    });

    // load current entries or empty
    const existing = sales[iso] ? JSON.parse(JSON.stringify(sales[iso].entries || {})) : {};
    currentWorking = { entries: existing };
    renderSublist(Object.keys(CATEGORIES)[0]);
    updateModalSaveTag();
  }

  function renderSublist(category){
    sublist.innerHTML = "";
    const subs = CATEGORIES[category] || [];
    if(subs.length === 0){
      // allow free input row
      const box = document.createElement('div'); box.className='subitem';
      const lbl = document.createElement('label'); lbl.textContent = 'Нет предустановленных типов';
      const inp = document.createElement('input'); inp.type='number'; inp.min=0; inp.value = currentWorking.entries[category] && (currentWorking.entries[category].__free||0) || 0;
      inp.addEventListener('input', ()=> {
        setQty(category, "__free", Number(inp.value)||0);
      });
      box.appendChild(lbl); box.appendChild(inp);
      sublist.appendChild(box);
      return;
    }

    subs.forEach(sub=>{
      const box = document.createElement('div'); box.className='subitem';
      const lbl = document.createElement('label'); lbl.textContent = sub;
      const inp = document.createElement('input'); inp.type='number'; inp.min=0; inp.value = (currentWorking.entries[category] && (Number(currentWorking.entries[category][sub])||0)) || 0;
      inp.addEventListener('input', ()=> {
        setQty(category, sub, Number(inp.value)||0);
      });
      box.appendChild(lbl); box.appendChild(inp);
      sublist.appendChild(box);
    });
  }

  function setQty(category, sub, qty){
    if(!currentWorking.entries[category]) currentWorking.entries[category] = {};
    currentWorking.entries[category][sub] = qty;
    updateModalSaveTag();
  }

  function updateModalSaveTag(){
    // show summary count
    const total = Object.values(currentWorking.entries).reduce((acc,cat)=> {
      if(typeof cat === 'object'){
        acc += Object.values(cat).reduce((a,v)=> a + (Number(v)||0), 0);
      }
      return acc;
    },0);
    dataTag.textContent = `Итого записей: ${total}`;
  }

  closeModal.addEventListener('click', ()=> { overlay.classList.remove('show'); currentIso=null; });
  overlay.addEventListener('click', (e)=> { if(e.target===overlay) overlay.classList.remove('show'); });
  clearDay.addEventListener('click', ()=>{
    if(!currentIso) return;
    if(!confirm("Удалить все записи за этот день?")) return;
    delete sales[currentIso];
    saveJSON(KEY_SALES, sales);
    overlay.classList.remove('show');
    renderCalendar();
  });

  saveDay.addEventListener('click', ()=>{
    if(!currentIso) return;
    // attach metadata (name, office) for this day
    sales[currentIso] = {
      name: user.name || "",
      office: user.office || "",
      savedAt: new Date().toISOString(),
      entries: currentWorking.entries
    };
    saveJSON(KEY_SALES, sales);
    overlay.classList.remove('show');
    renderCalendar();
  });

  // initial render
  renderHeader();
  renderCalendar();

  // small accessibility: prevent modal escaping viewport with keyboard
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape' && overlay.classList.contains('show')) overlay.classList.remove('show');
  });

  // Ensure title not overlapping on tiny screens
  window.addEventListener('resize', ()=> {
    const days = document.querySelectorAll('.day');
    days.forEach(d=> d.classList.toggle('small', window.innerWidth < 700));
  });

  // focus: require name on first run
  if(!user.name){
    setTimeout(()=> {
      if(confirm("ФИО не задано. Ввести сейчас?")) editNameBtn.click();
    }, 300);
  }

  // expose for debugging (disabled normally)
  window.__zp_dump = ()=> ({user,offices,sales});
})();
</script>
</body>
</html>

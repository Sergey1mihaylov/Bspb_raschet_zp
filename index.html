<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ЗП — Календарь и Зарплата</title>
<style>
  :root{--accent:#d90000;--bg:#f6f7fb;--card:#fff;--muted:#566;}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#111;}
  .app{max-width:1100px;margin:8px auto;padding:8px;min-height:100vh;display:flex;flex-direction:column;gap:8px;overflow:hidden}
  header{position:sticky;top:0;background:transparent;z-index:40}
  .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 4px}
  .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,var(--accent),#ff6b6b);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  .title{font-weight:700}
  .staticHeader{background:var(--card);padding:10px;border-radius:10px;box-shadow:0 8px 20px rgba(2,6,23,0.06);display:flex;justify-content:space-between;align-items:center;gap:12px;position:sticky;top:60px;z-index:30}
  .staticLeft{display:flex;align-items:center;gap:12px}
  .nameDisplay{font-weight:700}
  .controls{display:flex;gap:8px;align-items:center}
  button{cursor:pointer;border:0;padding:8px 10px;border-radius:8px;background:var(--accent);color:white;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--accent);font-weight:600}
  .content{flex:1;overflow:auto;padding:10px}
  .page{display:none}
  .page.active{display:block}

  /* calendar */
  .calWrap{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .calHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .weekday{text-align:center;color:var(--muted);font-size:13px}
  .day{background:linear-gradient(180deg,#fff,#fbfdff);border-radius:8px;min-height:60px;display:flex;align-items:flex-start;justify-content:center;padding:8px;font-weight:700;cursor:pointer;border:1px solid #eef2f7}
  .day.small{min-height:48px;font-size:14px}
  .day:active{transform:scale(.997)}
  /* modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:70}
  .overlay.show{display:flex}
  .modal{background:var(--card);border-radius:10px;padding:12px;max-width:920px;width:100%;max-height:90vh;overflow:auto;box-shadow:0 16px 40px rgba(2,6,23,0.3)}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
  .tab{padding:8px 10px;border-radius:8px;background:#f3f6fb;border:1px solid #e8eefc;cursor:pointer;font-weight:700}
  .tab.active{background:linear-gradient(90deg,#eef7ff,#fff);border-color:rgba(11,102,255,0.18)}
  .sublist{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px}
  .subitem{background:#fbfdff;border:1px solid #eef6ff;padding:8px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;gap:8px}
  input[type="number"], select, input[type="text"]{padding:8px;border:1px solid #e6e9ef;border-radius:6px;font-size:14px;background:white;width:100%}
  .footer{display:flex;justify-content:space-between;gap:8px;margin-top:12px}

  /* salary page */
  .salaryCard{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .row{display:flex;gap:8px;align-items:center}
  .rates{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #efefef;text-align:left}
  .small{font-size:13px;color:var(--muted)}
  .controlsRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}

  /* bottom nav */
  .bottomNav{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:8px;padding:8px;background:var(--card);border-radius:999px;box-shadow:0 8px 30px rgba(2,6,23,0.12);z-index:80}
  .navBtn{padding:10px 14px;border-radius:999px;border:0;background:transparent;color:var(--accent);font-weight:800}
  .navBtn.active{background:linear-gradient(90deg,var(--accent),#ff6b6b);color:white}

  /* responsive & safety */
  @media (max-width:700px){ .day{min-height:48px} .modal{max-width:95vw} .staticHeader{flex-direction:column;align-items:flex-start} }
  html,body{overflow-x:hidden}
</style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div class="top">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="logo">ЗП</div>
          <div>
            <div class="title">Расчёт продаж — локально</div>
            <div class="small">Данные хранятся только на устройстве</div>
          </div>
        </div>
        <div class="controls">
          <button id="exportAll" class="ghost">Экспорт JSON</button>
          <button id="importAll" class="ghost">Импорт JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
        </div>
      </div>

      <div class="staticHeader">
        <div class="staticLeft">
          <div>
            <div class="nameDisplay" id="nameDisplay">—</div>
            <!-- removed labels as requested -->
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="officeSelect" style="min-width:220px"></select>
          <button id="editName" class="ghost">Изменить</button>
        </div>
      </div>
    </header>

    <div class="content">
      <!-- CALENDAR PAGE -->
      <section id="pageCalendar" class="page active">
        <div class="calWrap">
          <div class="calHead">
            <div style="display:flex;gap:8px;align-items:center">
              <button id="prevMonth" class="ghost">&larr;</button>
              <div id="monthLabel" class="small"></div>
              <button id="nextMonth" class="ghost">&rarr;</button>
            </div>
            <div class="small">Нажми на число — добавить продажу</div>
          </div>

          <div class="calGrid" id="weekdays"></div>
          <div class="calGrid" id="calendar"></div>
        </div>
      </section>

      <!-- SALARY PAGE -->
      <section id="pageSalary" class="page">
        <div class="salaryCard">
          <h3>Расчёт зарплаты</h3>

          <div class="controlsRow">
            <label class="small">Период:</label>
            <input type="date" id="fromDate">
            <input type="date" id="toDate">
            <label class="small">Категория:</label>
            <select id="filterCat"><option value="all">Все</option></select>
            <label class="small">Офис:</label>
            <select id="filterOffice"><option value="all">Все</option></select>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
            <div style="flex:1">
              <div class="small">Ставки (руб. за 1 продажу) — редактируемые</div>
              <div class="rates" id="ratesContainer"></div>
            </div>
            <div style="width:220px">
              <div class="small">Итог</div>
              <div style="font-size:22px;font-weight:800" id="salaryTotal">0 ₽</div>
              <button id="saveCalc" style="width:100%;margin-top:8px">Сохранить расчёт</button>
              <button id="exportCSV" class="ghost" style="width:100%;margin-top:8px">Экспорт CSV</button>
            </div>
          </div>

          <div>
            <table aria-live="polite">
              <thead>
                <tr><th>Категория</th><th>Подтип</th><th>Кол-во</th><th>Ставка, ₽</th><th>Сумма, ₽</th></tr>
              </thead>
              <tbody id="salaryBody"></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>

    <!-- bottom nav -->
    <div class="bottomNav" role="navigation">
      <button id="navCal" class="navBtn active">Календарь</button>
      <button id="navSal" class="navBtn">Зарплата</button>
    </div>

    <!-- Modal for day input -->
    <div class="overlay" id="overlay" aria-modal="true" role="dialog">
      <div class="modal" role="document">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div id="modalTitle" style="font-weight:800"></div><div class="small" id="modalMeta"></div></div>
          <div><button id="closeModal" class="ghost">Закрыть</button></div>
        </div>

        <div class="tabs" id="categoryTabs" role="tablist"></div>
        <div id="sublist" class="sublist"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <input type="number" id="inputQty" min="1" placeholder="Количество">
          <button id="addEntry">Добавить</button>
        </div>

        <div class="footer">
          <div class="small" id="entriesCount">Итого: 0</div>
          <div style="display:flex;gap:8px">
            <button id="clearDay" class="ghost">Очистить</button>
            <button id="saveDay">Готово</button>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* =================== DATA MODEL =================== */
const CATEGORIES = {
  "КК": ["Рассм.","заявка","сплит"],
  "ПК": ["Заявка","выдача"],
  "ТА": ["Яркая","Другие","ЕКП","МА"],
  "Накопит": ["Вклад","НС.","МА выдача","СМС","Лид ЦПО","Лид Ипотека"],
  "ПЕНС": ["Военный","Страховая"],
  "Страховки": []
};

// storage keys
const KEY_USER = "zp_user_v2";
const KEY_OFFICES = "zp_offices_v2";
const KEY_SALES_PREFIX = "sales_"; // sales_YYYY-M-D
const KEY_RATES = "zp_rates_v2";
const KEY_SAVED_CALCS = "zp_saved_calcs_v2";

/* =================== UTIL =================== */
function q(id){return document.getElementById(id)}
function isoDate(d){ const y=d.getFullYear(), m=(d.getMonth()+1).toString().padStart(2,'0'), day=(d.getDate()).toString().padStart(2,'0'); return `${y}-${m}-${day}` }
function parseIso(s){ return new Date(s); }
function loadJSON(key, fallback){try{const v=localStorage.getItem(key);return v?JSON.parse(v):fallback}catch(e){return fallback}}
function saveJSON(key,obj){localStorage.setItem(key,JSON.stringify(obj))}

/* =================== INIT USER / OFFICES =================== */
let user = loadJSON(KEY_USER, {name:"", office:""});
let offices = loadJSON(KEY_OFFICES, ["Центральный","Коммерческий деп. 1","Коммерческий деп. 2","ДО \"Северный\""]);

function ensureUser() {
  if(!user.name){
    const name = prompt("Введите ФИО:") || "Пользователь";
    user.name = name.trim();
  }
  if(!user.office){
    user.office = offices[0] || "Центральный";
  }
  saveJSON(KEY_USER, user);
}
ensureUser();

/* render header/office select */
function renderHeader(){
  q('nameDisplay').textContent = `${user.name} | ${user.office}`;
  const sel = q('officeSelect');
  sel.innerHTML = "";
  offices.forEach(o=>{
    const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt);
  });
  sel.value = user.office || offices[0];
}
renderHeader();
q('officeSelect').addEventListener('change', ()=>{
  user.office = q('officeSelect').value; saveJSON(KEY_USER,user); renderHeader();
});
q('editName').addEventListener('click', ()=>{
  const v = prompt("Фамилия и имя:", user.name||"") || user.name;
  user.name = v.trim(); saveJSON(KEY_USER,user); renderHeader();
});

/* import/export JSON */
q('exportAll').addEventListener('click', ()=>{
  // gather sales keys
  const pack = { user, offices, rates: loadJSON(KEY_RATES, {}), savedCalcs: loadJSON(KEY_SAVED_CALCS, {}) , sales:{} };
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith(KEY_SALES_PREFIX)) pack.sales[k] = JSON.parse(localStorage.getItem(k));
  });
  const blob = new Blob([JSON.stringify(pack,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`zp-export-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove();
});
q('importAll').addEventListener('click', ()=> q('importFile').click());
q('importFile').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const obj = JSON.parse(txt);
    if(obj.user) { user = obj.user; saveJSON(KEY_USER,user); renderHeader(); }
    if(obj.offices) { offices = obj.offices; saveJSON(KEY_OFFICES,offices); renderHeader(); }
    if(obj.rates) saveJSON(KEY_RATES,obj.rates);
    if(obj.sales) {
      Object.keys(obj.sales).forEach(k=> localStorage.setItem(k, JSON.stringify(obj.sales[k])));
    }
    if(obj.savedCalcs) saveJSON(KEY_SAVED_CALCS, obj.savedCalcs);
    alert('Импорт завершён');
    renderCalendar(); populateFilters();
  }catch(e){ alert('Ошибка импорта: '+e.message) }
  ev.target.value = "";
});

/* =================== CALENDAR =================== */
const weekdays = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];
const monthNames = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
const weekHead = q('weekdays');
weekdays.forEach(w=> { const el=document.createElement('div'); el.className='weekday'; el.textContent=w; weekHead.appendChild(el); });

let viewDate = new Date(); // month view
function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1)}
function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0)}
q('prevMonth').addEventListener('click', ()=> { viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()-1,1); renderCalendar(); });
q('nextMonth').addEventListener('click', ()=> { viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()+1,1); renderCalendar(); });

function renderCalendar(){
  const calendarEl = q('calendar');
  calendarEl.innerHTML = "";
  q('monthLabel').textContent = `${monthNames[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
  const first = startOfMonth(viewDate);
  const firstWeekday = (first.getDay()+6)%7; // Mon=0..Sun=6
  const daysInMonth = endOfMonth(viewDate).getDate();
  for(let i=0;i<firstWeekday;i++){ const b=document.createElement('div'); calendarEl.appendChild(b); }
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
    const iso = isoDate(date);
    const cell = document.createElement('div'); cell.className='day'; if(window.innerWidth<700) cell.classList.add('small');
    cell.textContent = d; // only number as requested
    cell.addEventListener('click', ()=> openModalForDate(iso));
    calendarEl.appendChild(cell);
  }
}
renderCalendar();
window.addEventListener('resize', ()=> { document.querySelectorAll('.day').forEach(d=> d.classList.toggle('small', window.innerWidth<700)); });

/* =================== MODAL (add entries) =================== */
const overlay = q('overlay'), modalTitle = q('modalTitle'), modalMeta = q('modalMeta'), categoryTabs = q('categoryTabs'), sublist = q('sublist');
let currentIso=null;
let currentWorking = { entries: {} };

function openModalForDate(iso){
  currentIso = iso;
  modalTitle.textContent = iso;
  modalMeta.textContent = `Данные для ${iso}`;
  overlay.classList.add('show');
  // build tabs
  categoryTabs.innerHTML = "";
  Object.keys(CATEGORIES).forEach((cat,idx)=>{
    const btn = document.createElement('button'); btn.className='tab'+(idx===0?' active':''); btn.textContent=cat;
    btn.addEventListener('click', ()=> { categoryTabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); renderSublist(cat); });
    categoryTabs.appendChild(btn);
  });
  // load existing
  const existing = loadJSON(currentIso, { entries: {} });
  currentWorking = { entries: existing.entries || {} };
  renderSublist(Object.keys(CATEGORIES)[0]);
  updateEntriesCount();
}
function renderSublist(category){
  sublist.innerHTML = "";
  const subs = CATEGORIES[category] || [];
  if(subs.length===0){
    const box=document.createElement('div'); box.className='subitem';
    const lbl=document.createElement('label'); lbl.textContent='(нет предустановленных)';
    const inp=document.createElement('input'); inp.type='number'; inp.min=0; inp.value=(currentWorking.entries[category] && currentWorking.entries[category].__free) || 0;
    inp.addEventListener('input', ()=> { setQty(category,'__free', Number(inp.value)||0); });
    box.appendChild(lbl); box.appendChild(inp); sublist.appendChild(box); return;
  }
  subs.forEach(sub=>{
    const box=document.createElement('div'); box.className='subitem';
    const lbl=document.createElement('label'); lbl.textContent=sub;
    const inp=document.createElement('input'); inp.type='number'; inp.min=0; inp.value=(currentWorking.entries[category] && (Number(currentWorking.entries[category][sub])||0)) || 0;
    inp.addEventListener('input', ()=> setQty(category, sub, Number(inp.value)||0));
    box.appendChild(lbl); box.appendChild(inp); sublist.appendChild(box);
  });
}
function setQty(category, sub, qty){
  if(!currentWorking.entries[category]) currentWorking.entries[category] = {};
  currentWorking.entries[category][sub] = qty;
  updateEntriesCount();
}
function updateEntriesCount(){
  const total = Object.values(currentWorking.entries).reduce((acc,cat)=> {
    if(typeof cat==='object') acc += Object.values(cat).reduce((a,v)=> a + (Number(v)||0),0);
    return acc;
  },0);
  q('entriesCount').textContent = `Итого: ${total}`;
}
q('addEntry').addEventListener('click', ()=>{
  // if user filled number in inputQty, add to active tab/subtype
  const qty = Number(q('inputQty').value || 0); if(!qty || qty<1) { alert('Введите кол-во'); return; }
  const activeTab = categoryTabs.querySelector('.tab.active'); if(!activeTab) return;
  const cat = activeTab.textContent;
  // pick first sub if exists
  const subs = CATEGORIES[cat] || [];
  const sub = subs.length? subs[0] : '__free';
  if(!currentWorking.entries[cat]) currentWorking.entries[cat] = {};
  currentWorking.entries[cat][sub] = (Number(currentWorking.entries[cat][sub])||0) + qty;
  // sync inputs if visible
  renderSublist(cat);
  q('inputQty').value = '';
  updateEntriesCount();
});
q('clearDay').addEventListener('click', ()=>{
  if(!currentIso) return;
  if(!confirm('Удалить все продажи за этот день?')) return;
  localStorage.removeItem(currentIso);
  currentWorking = { entries:{} };
  overlay.classList.remove('show');
  renderCalendar();
});
q('saveDay').addEventListener('click', ()=>{
  if(!currentIso) return;
  const payload = { name: user.name, office: user.office, savedAt: new Date().toISOString(), entries: currentWorking.entries };
  localStorage.setItem(currentIso, JSON.stringify(payload));
  overlay.classList.remove('show');
  renderCalendar();
});
q('closeModal').addEventListener('click', ()=> overlay.classList.remove('show'));
overlay.addEventListener('click', e=> { if(e.target===overlay) overlay.classList.remove('show'); });

/* =================== SALARY PAGE =================== */
const pageCalendar = q('pageCalendar'), pageSalary = q('pageSalary');
q('navCal').addEventListener('click', ()=> { setActivePage('calendar'); });
q('navSal').addEventListener('click', ()=> { setActivePage('salary'); renderSalaryPage(); });

function setActivePage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.navBtn').forEach(b=>b.classList.remove('active'));
  if(name==='calendar'){ pageCalendar.classList.add('active'); q('navCal').classList.add('active'); }
  else { pageSalary.classList.add('active'); q('navSal').classList.add('active'); }
}

/* RATES: load or init */
let rates = loadJSON(KEY_RATES, null);
if(!rates){
  rates = {};
  Object.keys(CATEGORIES).forEach(cat=>{
    rates[cat] = {};
    (CATEGORIES[cat].length? CATEGORIES[cat] : ['__free']).forEach(sub=>{
      rates[cat][sub] = 500; // default 500 ₽ per sale — reasonable placeholder
    });
  });
  saveJSON(KEY_RATES, rates);
}

/* populate rates UI and filters */
function populateRatesUI(){
  const container = q('ratesContainer'); container.innerHTML = "";
  Object.keys(rates).forEach(cat=>{
    Object.keys(rates[cat]).forEach(sub=>{
      const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column';
      const lbl = document.createElement('div'); lbl.textContent = `${cat} — ${sub}`; lbl.style.fontWeight='700';
      const inp = document.createElement('input'); inp.type='number'; inp.min=0; inp.value = rates[cat][sub];
      inp.addEventListener('change', ()=> { rates[cat][sub] = Number(inp.value)||0; saveJSON(KEY_RATES,rates); renderSalaryPage(); });
      wrap.appendChild(lbl); wrap.appendChild(inp); container.appendChild(wrap);
    });
  });
}
function populateFilters(){
  const fc = q('filterCat'); fc.innerHTML = '<option value="all">Все</option>';
  Object.keys(CATEGORIES).forEach(cat=> { const o=document.createElement('option'); o.value=cat; o.textContent=cat; fc.appendChild(o); });
  const fo = q('filterOffice'); fo.innerHTML = '<option value="all">Все</option>';
  offices.forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; fo.appendChild(opt); });
}
populateFilters();
populateRatesUI();

/* collect sales from localStorage by date range and filters */
function collectSales(fromIso, toIso, filterCategory='all', filterOffice='all'){
  // iterate keys in localStorage with format YYYY-MM-DD or sales_... earlier? our calendar saves by iso key directly (currentIso)
  // Accept both: keys that look like "2025-12-04" and keys starting with "sales_" or any iso-like keys.
  const items = [];
  Object.keys(localStorage).forEach(k=>{
    if(k===KEY_USER || k===KEY_OFFICES || k===KEY_RATES || k===KEY_SAVED_CALCS) return;
    // pick storages that look like dates or sale keys
    let isSale = false;
    let dateKey = null;
    if(/^\\d{4}-\\d{2}-\\d{2}$/.test(k)){ isSale=true; dateKey=k; }
    else if(k.startsWith(KEY_SALES_PREFIX)) { isSale=true; dateKey = k.slice(KEY_SALES_PREFIX.length); }
    else if(k.startsWith('sales_')) { isSale=true; dateKey = k.slice(6); } // legacy
    if(!isSale) return;
    try{
      const payload = JSON.parse(localStorage.getItem(k));
      const entries = payload.entries || {};
      const name = payload.name || '';
      const officeName = payload.office || '';
      const dateIso = dateKey;
      const dateObj = new Date(dateIso);
      if(isNaN(dateObj)) return;
      if(fromIso && dateIso < fromIso) return;
      if(toIso && dateIso > toIso) return;
      if(filterOffice!=='all' && officeName!==filterOffice) return;
      // accumulate per subitem
      Object.keys(entries).forEach(cat=>{
        const subObj = entries[cat];
        if(typeof subObj !== 'object') return;
        Object.keys(subObj).forEach(sub=>{
          const qty = Number(subObj[sub]) || 0;
          if(qty<=0) return;
          if(filterCategory!=='all' && filterCategory!==cat) return;
          items.push({ date: dateIso, category: cat, sub, qty, office: officeName, name });
        });
      });
    }catch(e){ /* skip invalid */ }
  });
  return items;
}

/* render salary page based on filters */
function renderSalaryPage(){
  populateRatesUI(); populateFilters();
  // default dates: start/end of current month
  const now = new Date();
  if(!q('fromDate').value){ const start = new Date(now.getFullYear(), now.getMonth(), 1); q('fromDate').value = isoDate(start); }
  if(!q('toDate').value){ const end = new Date(now.getFullYear(), now.getMonth()+1, 0); q('toDate').value = isoDate(end); }

  const from = q('fromDate').value || null;
  const to = q('toDate').value || null;
  const cat = q('filterCat').value || 'all';
  const office = q('filterOffice').value || 'all';

  const items = collectSales(from, to, cat, office);
  // aggregate: map by cat+sub
  const agg = {};
  items.forEach(it=>{
    const key = `${it.category}||${it.sub}`;
    if(!agg[key]) agg[key] = { category: it.category, sub: it.sub, qty:0 };
    agg[key].qty += it.qty;
  });
  // build table
  const body = q('salaryBody'); body.innerHTML = "";
  let totalSum = 0;
  Object.values(agg).forEach(row=>{
    const rate = (rates[row.category] && (rates[row.category][row.sub] !== undefined ? rates[row.category][row.sub] : 0)) || 0;
    const sum = row.qty * rate; totalSum += sum;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.category}</td><td>${row.sub}</td><td>${row.qty}</td><td>${rate}</td><td>${sum}</td>`;
    body.appendChild(tr);
  });
  q('salaryTotal').textContent = `${totalSum.toLocaleString('ru-RU')} ₽`;
}

/* events: filters change */
['fromDate','toDate','filterCat','filterOffice'].forEach(id=> q(id).addEventListener('change', renderSalaryPage));
q('filterCat').addEventListener('change', ()=> renderSalaryPage());
q('filterOffice').addEventListener('change', ()=> renderSalaryPage());

/* save calculation snapshot */
q('saveCalc').addEventListener('click', ()=>{
  const snapshot = {
    ts: new Date().toISOString(),
    from: q('fromDate').value, to: q('toDate').value,
    cat: q('filterCat').value, office: q('filterOffice').value,
    rates, total: q('salaryTotal').textContent
  };
  const prev = loadJSON(KEY_SAVED_CALCS, []);
  prev.push(snapshot); saveJSON(KEY_SAVED_CALCS, prev);
  alert('Расчёт сохранён');
});

/* export CSV */
q('exportCSV').addEventListener('click', ()=>{
  const from = q('fromDate').value || null; const to = q('toDate').value || null;
  const cat = q('filterCat').value || 'all'; const office = q('filterOffice').value || 'all';
  const items = collectSales(from,to,cat,office);
  // aggregate per date/category/sub
  const rows = [];
  items.forEach(it=> rows.push([it.date, it.office || '', it.category, it.sub, it.qty]));
  // header
  let csv = 'Дата;Офис;Категория;Подтип;Кол-во\\n';
  rows.forEach(r=> csv+= r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(';') + '\\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `zp-${(new Date()).toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
});

/* export/import/back-compat helper: some old keys may be stored as sales_YYYY-M-D or iso directly.
   For writing a day we used localStorage.setItem(currentIso, payload). Keep that behaviour:
*/
function saveDayIso(iso, payload){
  // save at key iso (like "2025-12-04")
  localStorage.setItem(iso, JSON.stringify(payload));
}

/* populate filters on load */
populateFilters();

/* initial page ready */
renderSalaryPage();

/* quick helper: keyboard escape closes modal */
window.addEventListener('keydown', (e)=> { if(e.key==='Escape') overlay.classList.remove('show'); });

/* expose a dump for debug (optional) */
window.__zp = { user, offices, rates, collectSales };

/* done */
</script>
</body>
</html>

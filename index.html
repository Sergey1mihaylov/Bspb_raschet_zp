<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ЗП — Банк Санкт-Петербург (мини-приложение)</title>
<style>
  :root{
    --bg:#0f1720;
    --panel:#0b1220;
    --accent:#0ea5a4;
    --muted:#9aa6b2;
    --card:#0f1b27;
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
    --gap:10px;
    --header-h:56px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color-scheme: dark;
  }
  /* strict no overflow */
  html,body{height:100%;margin:0;padding:0;overflow:hidden;background:linear-gradient(180deg,#08101a,#071018);}
  *{box-sizing:border-box}

  /* app container fits exactly viewport */
  .app{
    height:100vh; width:100vw;
    display:flex; flex-direction:column;
    gap:var(--gap); padding:12px;
    align-items:stretch;
  }

  /* header */
  .top{
    height:var(--header-h);
    display:flex; align-items:center; gap:12px;
  }
  .logo{
    display:flex; align-items:center; gap:10px;
    color:var(--accent); font-weight:600;
  }
  .tabs{
    margin-left:auto; display:flex; gap:8px;
  }
  .tab-btn{
    background:var(--glass); border:1px solid rgba(255,255,255,0.03);
    padding:8px 12px; border-radius:10px; color:var(--muted); cursor:pointer; font-weight:600;
  }
  .tab-btn.active{background:linear-gradient(90deg, rgba(14,165,164,0.14), rgba(14,165,164,0.06)); color:var(--accent); box-shadow:0 4px 18px rgba(0,0,0,0.6);}

  /* content area fills remaining space */
  .content{
    flex:1 1 auto;
    display:flex; gap:12px; align-items:stretch;
    min-height:0; /* important for flex children overflow handling */
  }

  /* left column (profile) and right column (salary) are narrow, calendar center is flexible */
  .col{
    background:var(--panel); border-radius:var(--radius); padding:12px;
    box-shadow: 0 6px 24px rgba(2,6,23,0.6);
    overflow:auto; /* internal scroll if needed */
  }
  .col.profile{width:280px; min-width:220px; max-width:340px;}
  .col.calendar{flex:1 1 auto; min-width:0;} /* min-width:0 to allow shrinking */
  .col.salary{width:280px; min-width:200px; max-width:340px; display:flex; flex-direction:column; justify-content:center; align-items:center;}

  /* profile layout */
  .avatar-wrap{display:flex; gap:12px; align-items:center}
  .avatar{
    width:84px; height:84px; border-radius:14px; background:linear-gradient(180deg,#0b1620,#051016); display:flex; align-items:center; justify-content:center; overflow:hidden;
    border:1px solid rgba(255,255,255,0.04);
  }
  .avatar img{width:100%; height:100%; object-fit:cover; display:block}
  .input{display:flex; flex-direction:column; gap:6px; margin-top:10px}
  .input label{font-size:12px; color:var(--muted)}
  .input input, .input select{
    background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); padding:8px 10px; border-radius:8px; color:#dfe9ee;
    font-size:14px;
  }
  .save-btn{margin-top:12px; padding:10px; width:100%; border-radius:10px; background:var(--accent); color:#05282a; font-weight:700; cursor:pointer; border:none;}

  /* calendar */
  .cal-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
  .month-title{font-weight:700; color:#d6eef0}
  .month-controls{display:flex; gap:8px}
  .btn-mini{padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:var(--muted); cursor:pointer}

  .weekdays, .dates{
    display:grid; grid-template-columns:repeat(7, 1fr); gap:6px;
  }
  .weekday{
    text-align:center; font-size:12px; color:var(--muted); padding:6px 0;
  }
  /* dates grid: each cell same width as weekday above because same grid columns */
  .date-cell{
    height:64px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));
    display:flex; align-items:flex-start; justify-content:flex-end; padding:6px; color:#cfe8ea; font-weight:600; cursor:pointer; user-select:none;
    border:1px solid rgba(255,255,255,0.02);
  }
  .date-cell:hover{box-shadow:0 8px 18px rgba(2,6,23,0.6)}
  .date-number{font-size:14px; color:#e6f6f6}

  /* modal */
  .modal{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:50;
  }
  .modal.open{display:flex}
  .modal-card{
    width:min(680px, 94vw); max-height:86vh; overflow:auto; background:var(--card); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.03);
  }
  .sales-list{display:flex; flex-direction:column; gap:8px; margin-top:12px}
  .sale-item{padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); display:flex; justify-content:space-between; gap:8px}

  /* footer hint */
  .hint{font-size:12px; color:var(--muted); margin-top:10px; text-align:center}

  /* ensure no horizontal overflow */
  .app, .content, .col, .modal-card {max-width:100vw; box-sizing:border-box}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="top">
    <div class="logo">ЗП • БСПБ</div>
    <div class="tabs" role="tablist" aria-label="Вкладки">
      <button class="tab-btn active" data-tab="profile">Профиль</button>
      <button class="tab-btn" data-tab="calendar">Календарь</button>
      <button class="tab-btn" data-tab="salary">Зарплата</button>
    </div>
  </div>

  <div class="content">
    <div class="col profile" id="profileCol">
      <div style="font-weight:700;color:#dff7f6">Профиль</div>
      <div class="avatar-wrap" style="margin-top:12px">
        <div class="avatar" id="avatarPreview">
          <span style="color:var(--muted);font-size:12px">Аватар</span>
        </div>
        <div style="flex:1">
          <div class="input">
            <label>Фамилия</label>
            <input id="surname" type="text" placeholder="Иванов" />
          </div>
          <div class="input" style="margin-top:8px">
            <label>Имя</label>
            <input id="name" type="text" placeholder="Иван" />
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="input">
          <label>Аватар (загрузить)</label>
          <input id="avatarInput" type="file" accept="image/*" />
        </div>

        <div class="input" style="margin-top:8px">
          <label>Должность</label>
          <select id="positionSelect"></select>
        </div>

        <div class="input" style="margin-top:8px">
          <label>Офис</label>
          <select id="officeSelect"></select>
        </div>

        <button class="save-btn" id="saveProfile">Сохранить профиль</button>
        <div class="hint">Данные сохраняются локально в браузере</div>
      </div>
    </div>

    <div class="col calendar" id="calendarCol">
      <div class="cal-header">
        <div class="month-title" id="monthTitle">Месяц</div>
        <div class="month-controls">
          <button class="btn-mini" id="prevMonth">&larr;</button>
          <button class="btn-mini" id="nextMonth">&rarr;</button>
          <button class="btn-mini" id="todayBtn">Сегодня</button>
        </div>
      </div>

      <div class="weekdays" id="weekdays">
        <!-- weekdays will be injected -->
      </div>

      <div class="dates" id="datesGrid" aria-label="Календарь">
        <!-- dates will be injected -->
      </div>
    </div>

    <div class="col salary" id="salaryCol">
      <div style="font-weight:700;color:#dff7f6">Зарплата</div>
      <div style="margin-top:12px;color:var(--muted)">Вкладка пока в разработке</div>
    </div>
  </div>
</div>

<!-- modal for day's sales -->
<div class="modal" id="modal">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div id="modalTitle" style="font-weight:700;color:#dff7f6">Продажи — <span id="modalDate"></span></div>
        <div style="font-size:13px;color:var(--muted)">Список продаж за выбранный день</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-mini" id="addSaleBtn">Добавить продажу</button>
        <button class="btn-mini" id="closeModal">Закрыть</button>
      </div>
    </div>

    <div class="sales-list" id="salesList">
      <!-- items -->
    </div>
  </div>
</div>

<script src="prices.js"></script>
<script>
/*
  index.html logic
  - Uses global PRICES from prices.js
  - Persists profile and sales in localStorage
  - Calendar: grid with exact 7 columns; weekdays header and dates aligned via same grid columns
*/

// safety: if PRICES not present, set defaults
if (typeof PRICES === 'undefined') {
  window.PRICES = { positions: {"СЭ":{base:0},"АЗ":{base:0}}, offices: ['ДО "Центральный"'], currency:'₽' };
}

const el = id => document.getElementById(id);

// Tabs
const tabs = document.querySelectorAll('.tab-btn');
tabs.forEach(btn => btn.addEventListener('click', ()=> {
  tabs.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const tab = btn.dataset.tab;
  showTab(tab);
}));

function showTab(tab){
  el('profileCol').style.display = tab === 'profile' ? 'block' : 'none';
  el('calendarCol').style.display = tab === 'calendar' ? 'block' : 'none';
  el('salaryCol').style.display = tab === 'salary' ? 'flex' : 'none';
}

// default
showTab('profile');

/* PROFILE */
const surnameInput = el('surname'), nameInput = el('name');
const avatarInput = el('avatarInput'), avatarPreview = el('avatarPreview');
const positionSelect = el('positionSelect'), officeSelect = el('officeSelect'), saveProfileBtn = el('saveProfile');

function populateSelects(){
  // positions from PRICES
  positionSelect.innerHTML = '';
  Object.keys(PRICES.positions||{}).forEach(k=>{
    const opt = document.createElement('option'); opt.value = k; opt.textContent = k; positionSelect.appendChild(opt);
  });
  // offices, ensure ДО "Центральный" first (PRICES already specified in that order)
  officeSelect.innerHTML = '';
  (PRICES.offices||[]).forEach(o=>{
    const opt = document.createElement('option'); opt.value = o; opt.textContent = o; officeSelect.appendChild(opt);
  });
}
populateSelects();

function loadProfile(){
  try{
    const raw = localStorage.getItem('bspb_profile');
    if(!raw) return;
    const p = JSON.parse(raw);
    surnameInput.value = p.surname||'';
    nameInput.value = p.name||'';
    positionSelect.value = p.position||positionSelect.options[0]?.value;
    officeSelect.value = p.office||officeSelect.options[0]?.value;
    if (p.avatarDataUrl){
      avatarPreview.innerHTML = '<img src="'+p.avatarDataUrl+'" alt="avatar">';
    }
  }catch(e){console.error(e)}
}
loadProfile();

avatarInput.addEventListener('change', ()=> {
  const f = avatarInput.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = e => {
    avatarPreview.innerHTML = '<img src="'+e.target.result+'" alt="avatar">';
    // temporary store in profile draft
    profileDraft.avatarDataUrl = e.target.result;
  };
  r.readAsDataURL(f);
});

const profileDraft = {};
saveProfileBtn.addEventListener('click', ()=>{
  const profile = {
    surname: surnameInput.value.trim(),
    name: nameInput.value.trim(),
    position: positionSelect.value,
    office: officeSelect.value,
    avatarDataUrl: profileDraft.avatarDataUrl || (avatarPreview.querySelector('img') ? avatarPreview.querySelector('img').src : null)
  };
  if (!profile.surname || !profile.name){
    alert('Заполните Фамилию и Имя');
    return;
  }
  localStorage.setItem('bspb_profile', JSON.stringify(profile));
  alert('Профиль сохранён локально');
});

/* CALENDAR */
// keep internal date pointer
let current = new Date();
current.setHours(0,0,0,0);

const monthTitle = el('monthTitle');
const weekdaysEl = el('weekdays');
const datesGrid = el('datesGrid');

const WEEKDAY_NAMES = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];

function buildWeekdays(){
  weekdaysEl.innerHTML = '';
  WEEKDAY_NAMES.forEach(d=>{
    const w = document.createElement('div');
    w.className = 'weekday';
    w.textContent = d;
    weekdaysEl.appendChild(w);
  });
}
buildWeekdays();

function startOfMonth(d){
  return new Date(d.getFullYear(), d.getMonth(), 1);
}
function endOfMonth(d){
  return new Date(d.getFullYear(), d.getMonth()+1, 0);
}
function addMonths(d, n){
  const res = new Date(d.getFullYear(), d.getMonth()+n, 1);
  return res;
}
function formatYMD(d){
  const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2);
  return `${y}-${m}-${dd}`;
}

function renderCalendar(){
  // title
  const monthName = current.toLocaleString('ru-RU',{month:'long', year:'numeric'});
  monthTitle.textContent = monthName[0].toUpperCase()+monthName.slice(1);

  // clear grid
  datesGrid.innerHTML = '';

  // find first day index (we want Monday=0)
  const first = startOfMonth(current);
  let firstWeekday = first.getDay(); // 0 Sun .. 6 Sat
  // convert to Mon=0..Sun=6
  firstWeekday = (firstWeekday + 6) % 7;

  const daysInMonth = endOfMonth(current).getDate();

  // add empty cells for days before first
  for(let i=0;i<firstWeekday;i++){
    const empty = document.createElement('div');
    empty.className='date-cell';
    empty.style.background='transparent';
    empty.style.border='none';
    datesGrid.appendChild(empty);
  }

  // add date cells
  for(let day=1; day<=daysInMonth; day++){
    const cell = document.createElement('button');
    cell.type='button';
    cell.className='date-cell';
    const dateNum = document.createElement('div');
    dateNum.className='date-number';
    dateNum.textContent = day;
    cell.appendChild(dateNum);

    // accessible date value
    const d = new Date(current.getFullYear(), current.getMonth(), day);
    const ymd = formatYMD(d);
    cell.dataset.date = ymd;

    cell.addEventListener('click', ()=> openDayModal(ymd));
    datesGrid.appendChild(cell);
  }

  // ensure total cells is multiple of 7 by adding trailing empty cells
  const totalCells = datesGrid.children.length;
  const addTrailing = (7 - (totalCells % 7)) % 7;
  for(let i=0;i<addTrailing;i++){
    const empty = document.createElement('div');
    empty.className='date-cell';
    empty.style.background='transparent';
    empty.style.border='none';
    datesGrid.appendChild(empty);
  }
}

el('prevMonth').addEventListener('click', ()=> { current = addMonths(current, -1); renderCalendar(); });
el('nextMonth').addEventListener('click', ()=> { current = addMonths(current, 1); renderCalendar(); });
el('todayBtn').addEventListener('click', ()=> { current = new Date(); current.setHours(0,0,0,0); renderCalendar(); });

renderCalendar();

/* MODAL for day */
const modal = el('modal'), modalDate = el('modalDate'), salesList = el('salesList');
el('closeModal').addEventListener('click', ()=> modal.classList.remove('open'));
modal.addEventListener('click', (e)=> { if(e.target===modal) modal.classList.remove('open'); });

function getSalesForDate(ymd){
  try{
    const raw = localStorage.getItem('bspb_sales_'+ymd) || '[]';
    return JSON.parse(raw);
  }catch(e){return []}
}
function saveSalesForDate(ymd, arr){
  localStorage.setItem('bspb_sales_'+ymd, JSON.stringify(arr));
}

function openDayModal(ymd){
  modal.classList.add('open');
  modalDate.textContent = ymd;
  renderSales(ymd);
}

function renderSales(ymd){
  salesList.innerHTML = '';
  const sales = getSalesForDate(ymd);
  if(sales.length===0){
    const empty = document.createElement('div');
    empty.style.color = 'var(--muted)';
    empty.textContent = 'Пока нет продаж за этот день';
    salesList.appendChild(empty);
  } else {
    sales.forEach((s,i)=>{
      const item = document.createElement('div');
      item.className='sale-item';
      item.innerHTML = '<div><div style="font-weight:700">'+(s.title||'Продажа')+'</div><div style="font-size:12px;color:var(--muted)">'+(s.note||'')+'</div></div><div style="min-width:80px;text-align:right"><div style="font-weight:800">'+(s.amount||'0')+' '+(PRICES.currency||'₽')+'</div><div style="font-size:12px;color:var(--muted)"><button data-i="'+i+'" style="background:none;border:none;color:var(--muted);cursor:pointer">Удалить</button></div></div>';
      salesList.appendChild(item);
    });
    // attach delete handlers
    salesList.querySelectorAll('button[data-i]').forEach(b=>{
      b.addEventListener('click', (e)=>{
        const idx = parseInt(e.target.dataset.i,10);
        const arr = getSalesForDate(ymd);
        arr.splice(idx,1);
        saveSalesForDate(ymd,arr);
        renderSales(ymd);
      });
    });
  }
  // attach add sale
  el('addSaleBtn').onclick = ()=> {
    const title = prompt('Краткое название продажи', 'Продажа');
    if (title === null) return;
    const amountRaw = prompt('Сумма продажи (число)', '0');
    if (amountRaw === null) return;
    const amount = parseFloat(amountRaw.replace(',','.')) || 0;
    const note = prompt('Комментарий (необязательно)', '') || '';
    const arr = getSalesForDate(ymd);
    arr.push({ title: title.trim(), amount, note });
    saveSalesForDate(ymd, arr);
    renderSales(ymd);
  };
}

/* initial safety/responsiveness */
window.addEventListener('resize', ()=> {
  // keep elements within viewport; no-op but placeholder to adjust if needed
});

// Load profile into UI on start
loadProfile();

</script>
</body>
</html>
